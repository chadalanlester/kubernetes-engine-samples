// This is our updated Jenkinsfile

// 1. REPLACE with your server URL
def K8S_SERVER = "https://10.10.0.201:6443" 

// 2. REPLACE with your long base64 CA cert string
def K8S_CA_CERT = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJS1J5UXRGcHNTVE13RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TlRFd016RXdNVFF6TWpoYUZ3MHpOVEV3TWprd01UUTRNamhhTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUURnMjg4UnA2dkg2MmwxMS80RmRNcFk5ODNmclA3N0RiUkNUMWx5WCs5L1pIUnNNRDNRUm15UTlwNnYKOVZ3M2pTUGQ3WFc2QWRPUDFHUXRmR2hYc3ZqcmZPcEpNQ2NhTjlYc1hPL3UzSWhGd0ZBZHFSMVVYeU13T3JDbwpueFIvai94Y0VWV0ZEek1YQTRzUWJZVno3VUFZNFJGWWh3a0xjK1IwbTNjUnRPWmxSL1BXeFhTZUJkSGNRS29aCjA4QnB2bTRmVU9PMkdmNEMzZ2pySU5BOUlRYVo0THRpdjQ5VkVYOXNFZTZPRmE2VE1yaXF0YkplbnN3bDREbVoKdDZtQ0daNmozRXlVNFkxZEVmeTAyTlk2R3BVNGNBSTJta1l1SjNMQVF2aE5GcGIyM2Y2cTducERXVk5iYzBuWQpUeVFYRE9xQnRXbENKTU4xYXlWNzFEemRRa1dEQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJUNzIvQnpKYkRZVXI5K2tqbXh2K2NiYVJhbVhUQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQjgrSGVvTnFRbwpQRGFkeUhZR2tlWVdQ2JVVjVpaE9jdXZVTDV5Q0QzazRqcWJCY1E5WlU3T1Z6aEZqaFBuZU01Z0lmYSt3QTdLCldzZFlEWTZUeDdxZ0cvcFo4TzUreGhkOFdPazZJck9IZHZCMWVnUElDMjJ4cytmTWFCYjdoVU5hVlFmWWViSGgKb3dvZXdHOGVHYXNLaWlMV1RSU3ptTC9XWGQzQi92L2FKNG1GYmV3MEMraTNwb3lMT2p0Ylc5UDJEa1NFeGNPTgpReGFkc20ydnIvU1cwTWwvcS9IS2lPUHhXeStGUlJValZLSUszeDkzR3hwa2xnRzRHbUxNZlh4U3pZUE9jdmRtCnVpVnIwdTk3WjFwWHNyNU9rR25OU0Q5VlhZdlJRbkY2bithUEZUMWV0UzdwRCtSSVorVWxKTW9QMHg1TEs1T2EKVmk0M09vU3Zwd1FECi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"

// 3. REPLACE with your Docker Hub username
def DOCKER_IMAGE = "chadalanlester/hello-app"

pipeline {
    agent any
    stages {
        stage('Build & Push') {
            steps {
                script {
                    def app = docker.build("${DOCKER_IMAGE}:${env.BUILD_NUMBER}")
                    docker.withRegistry('https://registry.hub.docker.com', 'docker-hub-creds') {
                        app.push()
                    }
                }
            }
        }
        stage('Deploy') {
            steps {
                script {
                    // This 'withKubeconfig' uses our 'Secret text' credential
                    withKubeconfig([
                        credentialsId: 'jenkins-k8s-token',
                        serverUrl: K8S_SERVER,
                        caCertificate: K8S_CA_CERT
                    ]) {
                        // First, update the image in our deployment manifest
                        sh "sed -i 's|image:.*|image: ${DOCKER_IMAGE}:${env.BUILD_NUMBER}|' k8s/deployment.yaml"

                        // Now, deploy all manifests in the k8s/ directory
                        sh "kubectl apply -f k8s/ -n apps"
                    }
                }
            }
        }
    }
}
