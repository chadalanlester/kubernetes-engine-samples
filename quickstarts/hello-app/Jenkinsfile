// --- START: PASTE YOUR VALUES HERE ---

// 1. REPLACE with your server URL
def K8S_SERVER = "https://10.10.0.201:6443" 

// 2. REPLACE with your long base64 CA cert string
def K8S_CA_CERT = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJS1J5UXRGcHNTVE13RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TlRFd016RXdNVFF6TWpoYUZ3MHpOVEV3TWprd01UUTRNamhhTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUURnMjg4UnA2dkg2MmwxMS80RmRNcFk5ODNmclA3N0RiUkNUMWx5WCs5L1pIUnNNRDNRUm15UTlwNnYKOVZ3M2pTUGQ3WFc2QWRPUDFHUXRmR2hYc3ZqcmZPcEpNQ2NhTjlYc1hPL3UzSWhGd0ZBZHFSMVVYeU13T3JDbwpueFIvai94Y0VWV0ZEek1YQTRzUWJZVno3VUFZNFJGWWh3a0xjK1IwbTNjUnRPWmxSL1BXeFhTZUJkSGNRS29aCjA4QnB2bTRmVU9PMkdmNEMzZ2pySU5BOUlRYVo0THRpdjQ5VkVYOXNFZTZPRmE2VE1yaXF0YkplbnN3bDREbVoKdDZtQ0daNmozRXlVNFkxZEVmeTAyTlk2R3BVNGNBSTJta1l1SjNMQVF2aE5GcGIyM2Y2cTducERXVk5iYzBuWQpUeVFYRE9xQnRXbENKTU4xYXlWNzFEemRRa1dEQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJUNzIvQnpKYkRZVXI5K2tqbXh2K2NiYVJhbVhUQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQjgrSGVvTnFRbwpQRGFkeUhZR2tlWVdQ2JVVjVpaE9jdXZVTDV5Q0QzazRqcWJCY1E5WlU3T1Z6aEZqaFBuZU01Z0lmYSt3QTdLCldzZFlEWTZUeDdxZ0cvcFo4TzUreGhkOFdPazZJck9IZHZCMWVnUElDMjJ4cytmTWFCYjdoVU5hVlFmWWViSGgKb3dvZXdHOGVHYXNLaWlMV1RSU3ptTC9XWGQzQi92L2FKNG1GYmV3MEMraTNwb3lMT2p0Ylc5UDJEa1NFeGNPTgpReGFkc20ydnIvU1cwTWwvcS9IS2lPUHhXeStGUlJValZLSUszeDkzR3hwa2xnRzRHbUxNZlh4U3pZUE9jdmRtCnVpVnIwdTk3WjFwWHNyNU9rR25OU0Q5VlhZdlJRbkY2bithUEZUMWV0UzdwRCtSSVorVWxKTW9QMHg1TEs1T2EKVmk0M09vU3Zwd1FECi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"

// 3. REPLACE with your Docker Hub username
def DOCKER_IMAGE = "chadalanlester/hello-app"

// --- END: PASTE YOUR VALUES HERE ---

pipeline {
    agent {
        kubernetes {
            namespace 'cicd'
            yaml """
            apiVersion: v1
            kind: Pod
            spec:
              containers:
              # Container 1: Kaniko for building
              - name: kaniko
                image: gcr.io/kaniko-project/executor:v1.12.1-debug
                command:
                - /bin/sh
                - -c
                args:
                - cat
                tty: true
                volumeMounts:
                - name: workspace
                  mountPath: /workspace

              # Container 2: Kubectl for deploying
              - name: kubectl
                image: bitnami/kubectl:latest
                command:
                - /bin/sh
                - -c
                args:
                - cat
                tty: true
                volumeMounts:
                - name: workspace
                  mountPath: /workspace

              volumes:
              - name: workspace
                emptyDir: {}
            """
        }
    }
    stages {
        // Stage 1: Checkout
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        // Stage 2: Build & Push
        stage('Build & Push') {
            steps {
                container('kaniko') {
                    script {
                        // FIXED: Wrap in withEnv to safely pass Groovy vars to the shell
                        withEnv([
                            "DESTINATION_IMAGE=${DOCKER_IMAGE}:${env.BUILD_NUMBER}"
                        ]) {
                            withCredentials([usernamePassword(credentialsId: 'docker-hub-token', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                                sh '''
                                # This line uses shell variables injected by withCredentials
                                echo "{\\"auths\\":{\\"https://index.docker.io/v1/\\":{\\"auth\\":\\"$(echo -n ${DOCKER_USER}:${DOCKER_PASS} | base64)\\"}}}" > /kaniko/.docker/config.json
                                
                                # FIXED: This line now uses the $DESTINATION_IMAGE shell variable
                                /kaniko/executor --dockerfile=Dockerfile --destination=${DESTINATION_IMAGE} --context=.
                                '''
                            }
                        }
                    }
                }
            }
        }

        // Stage 3: Deploy
        stage('Deploy') {
            steps {
                container('kubectl') {
                    script {
                        withKubeconfig([
                            credentialsId: 'jenkins-k8s-token',
                            serverUrl: K8S_SERVER,
                            caCertificate: K8S_CA_CERT
                        ]) {
                            // FIXED: Use withEnv here as well for the same reason
                            withEnv(["DESTINATION_IMAGE=${DOCKER_IMAGE}:${env.BUILD_NUMBER}"]) {
                                sh "sed -i 's|image:.*|image: ${DESTINATION_IMAGE}|' \${WORKSPACE}/quickstarts/hello-app/k8s/deployment.yaml"
                                sh "kubectl apply -f \${WORKSPACE}/quickstarts/hello-app/k8s/ -n apps"
                            }
                        }
                    }
                }
            }
        }
    }
}
